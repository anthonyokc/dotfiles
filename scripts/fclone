#!/bin/bash
# fclone: Clone a GitHub repository using fzf and gum

# fzf fuzzy search of git repositories, then clone
function fclone() {

    selection="$(
        (echo "Other"; cat $fzf_git_cache 2>/dev/null; gum spin --title "Searching for GitHub Repos..." -- $HOME/scripts/listrepo_gql $GITHUB_SEARCH_OAUTH_TOKEN $GITHUB_ORG) | \
        tee $fzf_git_cache | \
        nauniq | \
        gum filter --limit 1 --placeholder 'Clone a repo' --height 50 --prompt='⬇️ ' --header="GitHub Repo Clone Tool" --header.foreground 5
    )"

    if [[ -z $selection ]]; then
        return
    fi

    if [[ "$selection" == "Other" ]]; then
        repo="$(gum input --placeholder 'user/repo' --prompt 'Enter GitHub repo (user/repo): ')"
        repo="${repo## }"; repo="${repo%% }" # trim spaces
        if [[ -z "$repo" || "$repo" != */* || "$repo" == *" "* || "$repo" == */ || "$repo" == /* ]]; then # validate format
            gum style --foreground 1 "Invalid format. Expected: user/repo (e.g., jalvesaq/nvimcom)."
            return 1
        fi
    else
        repo="$selection"
    fi

    echo "Cloning '$repo' from Github"
    git clone "git@github.com:$repo.git" "$HOME/code/$repo"
}

fclone
